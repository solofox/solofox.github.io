---
layout: post
title: "BPF Compiler Explained"
description: "A series articles explain the internal contruction of Berkeley Packet Filter Compiler internal"
category: BPF Compiler Explained
tags: [BPF, compiler]
---
{% include JB/setup %}

Tcpdump/wireshark are useful network traffic analysis tools, they are based on libpcap. Tcpdump/wireshark accept a filter expression named Berkeley Packet Filter (BPF) to quickly filter out the interested packets so avoid mass unrelated packets captured & dumped.

The BPF is a mini-language which operate on packet contents to produce a prediction on the packet: whether it should be accepted or rejected? The filter expression is compiled into BPF instructions, then runs on a BPF pseudo-machine. The job to translate the filter expression to BPF instructions is carried by BPF compiler, which is provided as libpcap's API:

```
int
pcap_compile(pcap_t *p, struct bpf_program *program,
	     const char *buf, int optimize, bpf_u_int32 mask);
```

the `buf` is the filter expression, `optimize` indicate when `pcap_compile` needs to do code optimization (like gcc -O2 turns on gcc optimization), `mask` is the network mask the captured interfaces's ipv4 address configuration. `program` stores output BPF instructions, denoted by struct bpf_program.

To see the correspondent BPF instructions generated by a specified expression, use `tcpdump -d`:

```
$ sudo tcpdump -d ip host 1.1.1.1
(000) ldh      [12]
(001) jeq      #0x800           jt 2	jf 7
(002) ld       [26]
(003) jeq      #0x1010101       jt 6	jf 4
(004) ld       [30]
(005) jeq      #0x1010101       jt 6	jf 7
(006) ret      #65535
(007) ret      #0
```

## Background

<<The BSD Packet Filter: A New Architecture for User-level Packet Capture>> [bpf-usenix93] describes the design of BPF filter model, instructions, pseudo-machine. I think bpf-usenix93 depicts everythings about what & why in BPF design, and this series articles just tell you how it's implemented. Everyone who want to understand BPF should read bpf-usenix93 carefully.

The filter expression syntax can be found on http://www.infosecwriters.com/text_resources/pdf/JStebelton_BPF.pdf. Remember the syntax rules help you to understand the frontend parsing.

Details about the instructions format, pesudo-machine environment & executions can be found at https://www.freebsd.org/cgi/man.cgi?query=bpf, under section FILTER MACINE. If you still has any problems, maybe the BPF pesudo-machine execution in bpf_filter.c is the best resort to dig out.

The better introduction than this post I found on web is http://blog.cloudflare.com/bpf-the-forgotten-bytecode. I think you should read this if you found this post is too hard to read.

To understand the internal of BPF compiler internal, you must has engough knowledge about compiler. And since BPF compiler is built using lex/yacc, you should study them first.

The following articals will be pushished focus on these topics:

* Intermediate Representation
* Code generation
* Optimization

I will try my best to release them on weekly basis, coming soon...

